name: Test GitHub 3899605

on:
  workflow_dispatch:
      test_iterations:
        description: 'Number of test iterations per job (36 jobs total in matrix)'
        required: false
        default: '5'
        type: string
      delay_between_tests:
        description: 'Delay between tests in seconds'
        required: false
        default: '5'
        type: string

jobs:
  test-connectivity:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        set1: [1, 2, 3, 4, 5, 6]
        set2: [1, 2, 3, 4, 5, 6]
    permissions:
      contents: read
      id-token: write   # can be removed now if you like

    steps:
      - name: Identify runner
        run: |
          echo "=== Runner Information (Job ${{ matrix.set1 }}.${{ matrix.set2 }}) ==="
          echo "Runner name: ${{ runner.name }}"
          echo "Runner OS: ${{ runner.os }}"
          echo "Hostname: $(hostname)"
          echo "Matrix: set1=${{ matrix.set1 }}, set2=${{ matrix.set2 }}"
          echo ""

      - name: Test GitHub API connectivity (baseline with GITHUB_TOKEN)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== Testing GitHub API connectivity with GITHUB_TOKEN ==="
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Runner: $(hostname)"
          echo ""
          echo "::add-mask::${GH_TOKEN}"

          echo "Testing API access to forest-town organization..."
          if curl -s -f -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/orgs/forest-town > /dev/null; then
            echo "✓ API access successful"
          else
            echo "✗ API access failed"
            exit 1
          fi

      - name: Load test - Clone anzx repositories via GitHub App tokens (script)
        env:
          ITERATIONS: ${{ github.event.inputs.test_iterations || '10' }}
          DELAY: ${{ github.event.inputs.delay_between_tests || '5' }}

          # GitHub App config (all from secrets)
          GH_APP_ID: ${{ secrets.GH_APP_ID }}
          GH_APP_INSTALLATION_ID:  ${{ secrets.GH_APP_INSTALLATION_ID }}
          GH_APP_PRIVATE_KEY_B64: ${{ secrets.GH_APP_PRIVATE_KEY_B64 }}
        run: |
          set -euo pipefail

          echo "=== Load Testing GitHub Clone Operations using GitHub App tokens ==="
          echo "Iterations: $ITERATIONS"
          echo "Delay between tests: ${DELAY}s"
          echo ""


          # --------------------------------------------------------------------
          # Helper: decode the private key once
          # --------------------------------------------------------------------
          PRIVATE_KEY_FILE="/tmp/gh-app-private-key.pem"
          echo "$GH_APP_PRIVATE_KEY_B64" | base64 -d > "$PRIVATE_KEY_FILE"
          chmod 600 "$PRIVATE_KEY_FILE"

          # --------------------------------------------------------------------
          # Helper: base64url (no padding, URL-safe)
          # --------------------------------------------------------------------
          base64url() {
            openssl base64 -A | tr '+/' '-_' | tr -d '='
          }

          # --------------------------------------------------------------------
          # Helper: generate a GitHub App JWT using the private key
          # --------------------------------------------------------------------
          generate_app_jwt() {
            local iat exp header payload header_b64 payload_b64 unsigned sig

            iat=$(date +%s)
            exp=$((iat + 540))  # 9 minutes (max is 10 min)

            header='{"alg":"RS256","typ":"JWT"}'
            payload=$(jq -nc --arg iat "$iat" --arg exp "$exp" --arg iss "$GH_APP_ID" \
              '{iat: ($iat|tonumber), exp: ($exp|tonumber), iss: $iss}')

            header_b64=$(printf '%s' "$header" | base64url)
            payload_b64=$(printf '%s' "$payload" | base64url)
            unsigned="${header_b64}.${payload_b64}"

            sig=$(printf '%s' "$unsigned" \
              | openssl dgst -sha256 -binary -sign "$PRIVATE_KEY_FILE" \
              | base64url)

            echo "${unsigned}.${sig}"
          }

          # --------------------------------------------------------------------
          # Helper: issue a GitHub App installation access token
          # We call this inside the loop to put load on GitHub's token API.
          # --------------------------------------------------------------------
          issue_github_app_token() {
            local app_jwt response token

            app_jwt=$(generate_app_jwt)
            echo "::add-mask::${app_jwt}"

            curl -fsS -X POST \
              -H "Authorization: Bearer ${app_jwt}" \
              -H "Accept: application/vnd.github+json" \
                 "https://api.github.com/app/installations/${GH_APP_INSTALLATION_ID}/access_tokens"

            set -x
            response=$(curl -fsS -X POST \
              -H "Authorization: Bearer ${app_jwt}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/app/installations/${GH_APP_INSTALLATION_ID}/access_tokens")
            token=$(echo "$response" | jq -r '.token')

            curl -fsS -X POST \
              -H "Authorization: Bearer ${app_jwt}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/app/installations/${GH_APP_INSTALLATION_ID}/access_tokens")

            if [ -z "$token" ] || [ "$token" = "null" ]; then
              echo "ERROR: Failed to extract token from response: $response" >&2
              return 1
            fi

            echo "$token"
            set +x
          }

          SUCCESS_COUNT=0
          FAIL_COUNT=0
          TOTAL_TIME=0
          TOKEN_ISSUE_FAILURES=0
          RETRY_SUCCESS_COUNT=0

          # Array of anzx repositories to test
          REPOS=(
            "forest-town/repo-a"
            "forest-town/repo-b"
            "forest-town/repo-c"
            "forest-town/repo-d"
          )

          for i in $(seq 1 "$ITERATIONS"); do
            echo "--- Iteration $i/$ITERATIONS ---"
            ITERATION_START=$(date +%s)

            for REPO in "${REPOS[@]}"; do
              REPO_NAME=$(basename "$REPO")
              TEST_DIR="/tmp/test-clone-${REPO_NAME}-${i}"

              echo "Testing: $REPO"
              echo "  Issuing GitHub App token for this iteration..."
              TOKEN_START=$(date +%s)
              sleep 5
              GH_TOKEN=$(issue_github_app_token 2>&1)
              sleep 5
              TOKEN_EXIT_CODE=$?
              set -e
              TOKEN_END=$(date +%s)
              TOKEN_DURATION=$((TOKEN_END - TOKEN_START))

              if [ $TOKEN_EXIT_CODE -ne 0 ] || [ -z "$GH_TOKEN" ] || [ "$GH_TOKEN" = "null" ]; then
                echo "  ✗ Failed to issue GitHub App token (duration: ${TOKEN_DURATION}s, exit code: $TOKEN_EXIT_CODE)"
                TOKEN_ISSUE_FAILURES=$((TOKEN_ISSUE_FAILURES + 1))
                FAIL_COUNT=$((FAIL_COUNT + 1))
                continue
              fi

              echo "::add-mask::${GH_TOKEN}"
              echo "  ✓ Token issued (length: ${#GH_TOKEN}, duration: ${TOKEN_DURATION}s)"

              START_TIME=$(date +%s)
              CLONE_TMP="/tmp/clone_output_${REPO_NAME}_${i}.txt"
              set +e
              git clone "https://oauth2:${GH_TOKEN}@github.com/${REPO}.git" "$TEST_DIR" > "$CLONE_TMP" 2>&1
              CLONE_EXIT_CODE=$?
              set -e
              cat "$CLONE_TMP"
              CLONE_OUTPUT=$(cat "$CLONE_TMP")
              rm -f "$CLONE_TMP"

              if [ $CLONE_EXIT_CODE -eq 0 ]; then
                END_TIME=$(date +%s)
                DURATION=$((END_TIME - START_TIME))
                echo "✓ Success - Clone took ${DURATION}s"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                TOTAL_TIME=$((TOTAL_TIME + DURATION))
                rm -rf "$TEST_DIR"
              else
                END_TIME=$(date +%s)
                DURATION=$((END_TIME - START_TIME))
                echo "✗ Failed (attempt 1) - Exit code: $CLONE_EXIT_CODE, Duration: ${DURATION}s"
                echo "Error output: $CLONE_OUTPUT"

                echo ""
                echo "=== Token Debug Information ==="
                echo "Token length: ${#GH_TOKEN}"
                echo "Token first 8 chars: ${GH_TOKEN:0:8}"
                echo "Token last 8 chars: ${GH_TOKEN: -8}"
                echo "Token pattern check: $(echo "$GH_TOKEN" | grep -oE '^[a-zA-Z0-9_-]\+$' && echo 'Valid format' || echo 'Invalid characters detected')"
                echo ""

                echo "Retrying clone with the same token (waiting 2s)..."
                sleep 2
                rm -rf "$TEST_DIR"

                RETRY_START=$(date +%s)
                RETRY_TMP="/tmp/retry_output_${REPO_NAME}_${i}.txt"
                set +e
                git clone "https://oauth2:${GH_TOKEN}@github.com/${REPO}.git" "$TEST_DIR" > "$RETRY_TMP" 2>&1
                RETRY_EXIT_CODE=$?
                set -e
                cat "$RETRY_TMP"
                RETRY_OUTPUT=$(cat "$RETRY_TMP")
                rm -f "$RETRY_TMP"
                RETRY_END=$(date +%s)
                RETRY_DURATION=$((RETRY_END - RETRY_START))

                if [ $RETRY_EXIT_CODE -eq 0 ]; then
                  echo "✓ Retry succeeded! - Duration: ${RETRY_DURATION}s"
                  echo "  => This indicates a transient network/proxy issue, NOT a token problem"
                  RETRY_SUCCESS_COUNT=$((RETRY_SUCCESS_COUNT + 1))
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                  TOTAL_TIME=$((TOTAL_TIME + RETRY_DURATION))
                  rm -rf "$TEST_DIR"
                else
                  echo "✗ Retry failed - Exit code: $RETRY_EXIT_CODE, Duration: ${RETRY_DURATION}s"
                  echo "Error output: $RETRY_OUTPUT"
                  echo "  => Consistent failure with same token suggests token or persistent network issue"
                  FAIL_COUNT=$((FAIL_COUNT + 1))

                  echo ""
                  echo "=== Network Diagnostics (after retry failure) ==="
                  echo "- DNS resolution:"
                  nslookup github.com 2>&1 || true
                  echo ""

                  echo "- Proxy settings:"
                  env | grep -i proxy || echo "No proxy variables set"
                  echo ""

                  echo "- Test HTTPS connectivity:"
                  curl -v https://github.com 2>&1 | head -20 || true
                  echo ""
                fi
              fi
              echo ""
            done

            ITERATION_END=$(date +%s)
            ITERATION_DURATION=$((ITERATION_END - ITERATION_START))
            echo "Iteration $i completed in ${ITERATION_DURATION}s"

            if [ "$i" -lt "$ITERATIONS" ]; then
              echo "Waiting ${DELAY}s before next iteration..."
              sleep "$DELAY"
            fi
            echo ""
          done

          TOTAL_TESTS=$((SUCCESS_COUNT + FAIL_COUNT))
          echo "=== Test Summary ==="
          echo "Total tests: $TOTAL_TESTS"
          echo "Successful: $SUCCESS_COUNT"
          echo "  - First attempt success: $((SUCCESS_COUNT - RETRY_SUCCESS_COUNT))"
          echo "  - Retry success (transient failures): $RETRY_SUCCESS_COUNT"
          echo "Failed: $FAIL_COUNT"
          echo "Token issuance failures: $TOKEN_ISSUE_FAILURES"

          if [ $SUCCESS_COUNT -gt 0 ]; then
            AVG_TIME=$((TOTAL_TIME / SUCCESS_COUNT))
            echo "Average clone time: ${AVG_TIME}s"
          fi

          if [ $FAIL_COUNT -gt 0 ] || [ $TOKEN_ISSUE_FAILURES -gt 0 ] || [ $RETRY_SUCCESS_COUNT -gt 0 ]; then
            if [ $TOTAL_TESTS -gt 0 ]; then
              FAIL_RATE=$(awk "BEGIN {printf \"%.2f\", ($FAIL_COUNT / $TOTAL_TESTS) * 100}")
              echo "Clone failure rate: ${FAIL_RATE}%"
            fi
            echo ""
            if [ $RETRY_SUCCESS_COUNT -gt 0 ]; then
              TRANSIENT_RATE=$(awk "BEGIN {printf \"%.2f\", ($RETRY_SUCCESS_COUNT / $TOTAL_TESTS) * 100}")
              echo "⚠️  Transient failures detected: $RETRY_SUCCESS_COUNT ($TRANSIENT_RATE%)"
              echo "  These succeeded on retry, indicating intermittent network/proxy issues"
            fi
            if [ $TOKEN_ISSUE_FAILURES -gt 0 ]; then
              echo "⚠️  Token issuance failures detected! This indicates issues talking to the GitHub App token endpoint"
            fi
            if [ $FAIL_COUNT -gt 0 ]; then
              echo "⚠️  Repository clone failures detected! (Failed even after retry)"
            fi
            exit 1
          else
            echo "Success rate: 100%"
            echo "✓ All connectivity and token issuance tests passed"
          fi
